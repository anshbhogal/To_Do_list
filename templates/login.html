<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TaskMaster - Login & Signup</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container" id="container">
    <!-- Sign Up -->
    <div class="form-container sign-up-container">
      <form id="signupForm" onsubmit="handleSignup(event)">
        <h1><i class="fas fa-user-plus"></i> Create Account</h1>
        <div class="input-group">
          <i class="fas fa-user"></i>
          <input type="text" id="signupUsername" name="username" placeholder="Username" required />
        </div>
        <div class="input-group">
          <i class="fas fa-lock"></i>
          <input type="password" id="signupPassword" name="password" placeholder="Password" required />
        </div>
        <button type="submit" class="btn-primary">
          <span class="btn-text">SIGN UP</span>
          <span class="btn-loading" style="display: none;">
            <i class="fas fa-spinner fa-spin"></i> Creating...
          </span>
        </button>
        <div id="signupError" class="error-message" style="display: none;"></div>
      </form>
    </div>

    <!-- Sign In -->
    <div class="form-container sign-in-container">
      <form id="loginForm" onsubmit="handleLogin(event)">
        <h1><i class="fas fa-sign-in-alt"></i> Welcome Back</h1>
        <div class="input-group">
          <i class="fas fa-user"></i>
          <input type="text" id="loginUsername" name="username" placeholder="Username" required />
        </div>
        <div class="input-group">
          <i class="fas fa-lock"></i>
          <input type="password" id="loginPassword" name="password" placeholder="Password" required />
        </div>
        <button type="submit" class="btn-primary">
          <span class="btn-text">SIGN IN</span>
          <span class="btn-loading" style="display: none;">
            <i class="fas fa-spinner fa-spin"></i> Signing in...
          </span>
        </button>
        <div id="loginError" class="error-message" style="display: none;"></div>
      </form>
    </div>

    <!-- Overlay -->
    <div class="overlay-container">
      <div class="overlay">
        <div class="overlay-panel overlay-left">
          <h1><i class="fas fa-heart"></i> Welcome Back!</h1>
          <p>To keep connected with us please login with your personal info</p>
          <button class="ghost" id="signIn">
            <i class="fas fa-sign-in-alt"></i> SIGN IN
          </button>
        </div>
        <div class="overlay-panel overlay-right">
          <h1><i class="fas fa-rocket"></i> Hello, Friend!</h1>
          <p>Enter your personal details and start your journey with us</p>
          <button class="ghost" id="signUp">
            <i class="fas fa-user-plus"></i> SIGN UP
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Panel switch animation
    const signUpBtn = document.getElementById("signUp");
    const signInBtn = document.getElementById("signIn");
    const container = document.getElementById("container");

    signUpBtn.addEventListener("click", () => {
      container.classList.add("right-panel-active");
      clearErrors();
    });
    
    signInBtn.addEventListener("click", () => {
      container.classList.remove("right-panel-active");
      clearErrors();
    });

    // Form handling functions
    async function handleLogin(event) {
      event.preventDefault();
      console.log('Login form submitted');
      console.log('Form ID:', event.target.id);
      console.log('Button text:', event.target.querySelector('.btn-text').textContent);
      
      const form = event.target;
      const button = form.querySelector('button[type="submit"]');
      const btnText = button.querySelector('.btn-text');
      const btnLoading = button.querySelector('.btn-loading');
      const errorDiv = document.getElementById('loginError');
      
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;

      console.log('Login data:', { username, password });

      // Show loading state
      btnText.style.display = 'none';
      btnLoading.style.display = 'inline';
      button.disabled = true;
      errorDiv.style.display = 'none';

      try {
        console.log('Sending request to /login');
        const response = await fetch('/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ username, password }),
        });

        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);

        if (response.ok) {
          // Success - redirect to dashboard
          window.location.href = `/dashboard?user_id=${data.user_id}`;
        } else {
          // Show error
          showError('loginError', data.error || 'Login failed');
        }
      } catch (error) {
        console.error('Login error:', error);
        showError('loginError', 'Network error. Please try again.');
      } finally {
        // Reset button state
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';
        button.disabled = false;
      }
    }

    async function handleSignup(event) {
      event.preventDefault();
      console.log('Signup form submitted');
      console.log('Form ID:', event.target.id);
      console.log('Button text:', event.target.querySelector('.btn-text').textContent);
      
      const form = event.target;
      const button = form.querySelector('button[type="submit"]');
      const btnText = button.querySelector('.btn-text');
      const btnLoading = button.querySelector('.btn-loading');
      const errorDiv = document.getElementById('signupError');
      
      const username = document.getElementById('signupUsername').value;
      const password = document.getElementById('signupPassword').value;

      console.log('Signup data:', { username, password });

      // Show loading state
      btnText.style.display = 'none';
      btnLoading.style.display = 'inline';
      button.disabled = true;
      errorDiv.style.display = 'none';

      try {
        console.log('Sending request to /register');
        const response = await fetch('/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ username, password }),
        });

        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);

        if (response.ok) {
          // Success - show success message and switch to login
          showSuccess('Account created successfully! Please sign in.');
          setTimeout(() => {
            container.classList.remove("right-panel-active");
            document.getElementById('loginUsername').value = username;
            document.getElementById('loginPassword').value = '';
          }, 1500);
        } else {
          // Show error
          showError('signupError', data.error || 'Registration failed');
        }
      } catch (error) {
        console.error('Signup error:', error);
        showError('signupError', 'Network error. Please try again.');
      } finally {
        // Reset button state
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';
        button.disabled = false;
      }
    }

    function showError(elementId, message) {
      const errorDiv = document.getElementById(elementId);
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    function showSuccess(message) {
      // Create a temporary success message
      const successDiv = document.createElement('div');
      successDiv.className = 'success-message';
      successDiv.textContent = message;
      successDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 15px 20px;
        border-radius: 5px;
        z-index: 1000;
        animation: slideIn 0.3s ease;
      `;
      document.body.appendChild(successDiv);
      
      setTimeout(() => {
        successDiv.remove();
      }, 3000);
    }

    function clearErrors() {
      document.getElementById('loginError').style.display = 'none';
      document.getElementById('signupError').style.display = 'none';
    }

    // Add CSS animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
